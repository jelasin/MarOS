# 项目01 - 引导扇区汇编程序教程(一)

## 项目概述

这是一个16位x86汇编语言编写的引导扇区程序，展示了基本的字符显示和数字转换功能。程序运行在实模式下，演示了如何直接操作硬件和内存。

## 文件结构

- `boot.S` - 主要的汇编源代码文件
- `Makefile` - 构建脚本（如果存在）

## 代码功能

1. **字符串显示**：在屏幕上显示 "Ciallo~^~" 文本
2. **数字转换**：将内存地址转换为十进制数字并显示
3. **引导扇区**：符合MBR引导扇区规范

## 核心知识点详解

### 1. 引导扇区基础

#### 什么是引导扇区？

引导扇区（Boot Sector）是硬盘第一个扇区（512字节），包含：

- 引导代码（最多446字节）
- 分区表（64字节）
- 引导签名（2字节：0x55AA）

#### 引导过程

1. BIOS上电自检（POST）
2. BIOS将引导扇区加载到内存地址`0x7C00`
3. 跳转到`0x7C00`开始执行代码

### 2. 实模式寻址

#### 段寄存器设置

```assembly
mov ax,0x7c0        ; 数据段基址 = 0x7C00
mov ds,ax           ; DS = 0x7C0

mov ax,0xb800       ; 显存段基址 = 0xB8000
mov es,ax           ; ES = 0xB800
```

#### 实模式内存计算

实模式下物理地址计算公式：

```text
物理地址 = 段基址 × 16 + 偏移地址
```

示例：

- `DS:SI` → `0x7C0 × 16 + SI = 0x7C00 + SI`
- `ES:DI` → `0xB800 × 16 + DI = 0xB8000 + DI`

### 3. 文本模式显存操作

#### 显存布局

- **起始地址**：`0xB8000`
- **大小**：4KB（80×25字符）
- **格式**：每个字符占2字节
  - 第1字节：ASCII字符码
  - 第2字节：颜色属性

#### 颜色属性格式

| 位 | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
|----|---|---|---|---|---|---|---|---|
| 功能 | 闪烁 | 背景红 | 背景绿 | 背景蓝 | 加亮 | 前景红 | 前景绿 | 前景蓝 |
| 代码 | B | R | G | B | I | R | G | B |

**颜色编码表：**

| 颜色值 | 描述 | 前景色 | 背景色 |
|--------|------|--------|--------|
| 0x07 | 白色字体，黑色背景 | 白色 | 黑色 |
| 0x04 | 红色字体，黑色背景 | 红色 | 黑色 |
| 0x0F | 亮白色字体，黑色背景 | 亮白色 | 黑色 |
| 0x1F | 亮白色字体，蓝色背景 | 亮白色 | 蓝色 |
| 0x2E | 黄色字体，绿色背景 | 黄色 | 绿色 |
| 0x47 | 白色字体，红色背景 | 白色 | 红色 |

### 4. 字符串操作指令

#### MOVSB指令详解

```assembly
cld                 ; 清除方向标志（DF=0）
rep movsb           ; 重复执行字符串复制
```

执行过程：

1. 将`DS:SI`处的字节复制到`ES:DI`
2. 如果DF=0，SI和DI递增
3. CX递减
4. 如果CX≠0，重复执行

### 5. 数字转换算法

#### 十进制分解原理

通过连续除以10，得到各个数位：

```text
示例：1234 转换过程
1234 ÷ 10 = 123 ... 4  （个位）
123  ÷ 10 = 12  ... 3  （十位）
12   ÷ 10 = 1   ... 2  （百位）
1    ÷ 10 = 0   ... 1  （千位）
0    ÷ 10 = 0   ... 0  （万位）
```

#### DIV指令详解

```assembly
div si              ; 16位除法
```

**操作数**：

- 被除数：`DX:AX`（32位）
- 除数：`SI`（16位）
- 商：`AX`
- 余数：`DX`

### 6. 循环控制

#### LOOP指令

```assembly
loop digit          ; CX递减，如果CX≠0则跳转
```

#### 条件跳转

```assembly
jns show            ; 如果符号标志SF=0则跳转
```

## 扩展知识

### 1. x86处理器架构

#### 寄存器组织

- **通用寄存器**：AX, BX, CX, DX
- **索引寄存器**：SI, DI
- **段寄存器**：CS, DS, ES, SS
- **指针寄存器**：SP, BP

#### 寄存器用途约定

- **AX**：累加器，算术运算
- **BX**：基址寄存器，内存寻址
- **CX**：计数器，循环控制
- **DX**：数据寄存器，I/O操作

### 2. 内存管理

#### 实模式内存布局

```text
0x00000 - 0x003FF  中断向量表
0x00400 - 0x004FF  BIOS数据区
0x00500 - 0x07BFF  可用内存
0x07C00 - 0x07DFF  引导扇区加载区
0x07E00 - 0x9FFFF  可用内存
0xA0000 - 0xBFFFF  显存区域
0xC0000 - 0xFFFFF  ROM区域
```

#### 段寄存器的作用

- **CS**：代码段，存储指令
- **DS**：数据段，存储数据
- **ES**：附加段，字符串操作目标
- **SS**：堆栈段，存储堆栈

### 3. 汇编语言语法

#### 数据定义

```assembly
db      ; 定义字节（8位）
dw      ; 定义字（16位）
dd      ; 定义双字（32位）
```

#### 标号和常量

```assembly
mytext:             ; 标号定义
number equ 100      ; 常量定义
```

#### 表达式计算

```assembly
mov cx,(number-mytext)  ; 编译时计算长度
```

### 4. 中断系统

#### BIOS中断服务

虽然本程序未使用中断，但可以通过BIOS中断实现：

- **INT 10H**：视频服务
- **INT 13H**：磁盘服务
- **INT 16H**：键盘服务

#### 中断向量表

位于内存`0x0000-0x03FF`，每个中断占4字节：

- 2字节偏移地址
- 2字节段地址

### 5. 硬件接口

#### 显卡寄存器

- **CRT控制器**：控制显示参数
- **属性控制器**：管理颜色映射
- **序列器**：控制显示时序

#### 键盘控制器

- **端口60H**：数据端口
- **端口64H**：状态/命令端口

## 编译和运行

### 编译环境

推荐使用：

- **NASM**：Netwide Assembler
- **QEMU**：虚拟机测试
- **Bochs**：x86模拟器

### 编译命令

```bash
nasm -f bin boot.S -o boot.bin
```

### 运行测试

```bash
qemu-system-i386 -fda boot.bin
```

## 调试技巧

### 1. 使用调试器

- **GDB**：配合QEMU远程调试
- **Bochs**：内置调试器
- **x64dbg**：Windows平台

### 2. 添加调试信息

```assembly
; 在关键位置添加断点
int 3               ; 软件断点
```

### 3. 内存检查

```assembly
; 检查内存内容
mov ax,[es:di]      ; 读取显存内容
```

## 常见问题

### 1. 段寄存器设置错误

确保正确设置段寄存器，否则会访问错误的内存区域。

### 2. 方向标志未清除

使用字符串操作前必须设置方向标志（CLD或STD）。

### 3. 除零错误

DIV指令遇到零除数会产生异常，需要检查除数。

### 4. 引导签名缺失

引导扇区必须以`0x55AA`结尾，否则BIOS不会识别。

## 学习路径

### 初学者

1. 理解汇编语言基本语法
2. 掌握寄存器和内存概念
3. 学习基本指令集

### 进阶学习

1. 中断和系统调用
2. 保护模式编程
3. 操作系统内核开发

### 实践项目

1. 扩展显示功能
2. 添加键盘输入
3. 实现简单的文件系统

## 参考资料

1. **Intel 8086 Family User's Manual**
2. **IBM PC Technical Reference**
3. **Assembly Language for x86 Processors** - Kip Irvine
4. **Professional Assembly Language** - Richard Blum

---

*本教程基于项目01的汇编代码，旨在帮助理解底层系统编程的基本概念。*
