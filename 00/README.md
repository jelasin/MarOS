# 第00章：计算机组成原理与8086汇编基础

## 📖 本章概述

本章将为您介绍计算机系统的基本组成和8086汇编语言的基础知识，这些是理解操作系统内核开发的重要基础。

## 🖥️ 计算机组成原理

### 1. 计算机系统的基本组成

计算机系统主要由以下几个部分组成：

```text
┌─────────────────────────────────────────┐
│                计算机系统                │
├─────────────────┬───────────────────────┤
│      硬件       │        软件           │
├─────────────────┼───────────────────────┤
│ • CPU (处理器)  │ • 系统软件           │
│ • 内存          │   - 操作系统         │
│ • 外存设备      │   - 编译器           │
│ • 输入输出设备  │   - 驱动程序         │
│ • 总线系统      │ • 应用软件           │
└─────────────────┴───────────────────────┘
```

### 2. 冯·诺依曼体系结构

现代计算机基于冯·诺依曼体系结构，具有以下特点：

- **程序存储**: 程序和数据都存储在同一存储器中
- **顺序执行**: 程序按顺序执行，除非遇到跳转指令
- **二进制表示**: 所有信息都用二进制表示
- **五大部件**: 运算器、控制器、存储器、输入设备、输出设备

## 🧠 CPU (中央处理器)

### 1. CPU的主要功能

- **指令执行**: 取指令 → 译码 → 执行 → 写回
- **数据处理**: 算术运算、逻辑运算
- **控制协调**: 控制各部件协调工作
- **地址生成**: 生成内存和I/O地址

### 2. CPU的基本组成

```text
┌─────────────────────────────────────┐
│              CPU                    │
├─────────────────┬───────────────────┤
│   控制单元(CU)  │   算术逻辑单元    │
│                 │      (ALU)        │
├─────────────────┼───────────────────┤
│   寄存器组      │    缓存(Cache)    │
└─────────────────┴───────────────────┘
```

### 3. CPU的工作周期

1. **取指(Fetch)**: 从内存中取出指令
2. **译码(Decode)**: 解析指令的操作和操作数
3. **执行(Execute)**: 执行指令操作
4. **写回(Write Back)**: 将结果写回寄存器或内存

## 💾 存储系统

### 1. 存储器层次结构

```text
速度快 ↑              容量小 ↑
──────┼──────────────────┼────────
      │    寄存器        │
      │     Cache        │
      │    主存(RAM)     │
      │    外存(硬盘)    │
速度慢 ↓              容量大 ↓
```

### 2. 内存 (主存储器)

**特点:**

- **易失性**: 断电后数据丢失
- **随机访问**: 可以随机访问任意位置
- **高速度**: 访问速度快，但比寄存器慢

**类型:**

- **RAM (Random Access Memory)**: 可读写的随机访问存储器
  - DRAM: 动态RAM，需要定期刷新
  - SRAM: 静态RAM，速度快但成本高
- **ROM (Read Only Memory)**: 只读存储器

**地址空间:**

- 每个内存位置都有唯一的地址
- 8086处理器有20位地址线，可寻址1MB内存空间

### 3. 外存 (辅助存储器)

**特点:**

- **非易失性**: 断电后数据不丢失
- **大容量**: 存储容量大
- **低速度**: 访问速度相对较慢

**常见类型:**

- **硬盘驱动器(HDD)**: 机械式存储，成本低
- **固态硬盘(SSD)**: 电子式存储，速度快
- **光盘**: CD、DVD、蓝光盘
- **闪存**: U盘、SD卡等

## 🔧 8086处理器架构

### 1. 8086处理器特点

- **16位处理器**: 数据总线16位，地址总线20位
- **1MB寻址空间**: 可寻址1,048,576字节内存
- **分段存储**: 使用段:偏移的地址模式
- **实模式**: 直接访问物理内存

### 2. 8086寄存器详解

#### 通用寄存器 (16位)

```text
┌─────────────────────────────────────────┐
│        AX (累加器)                      │
├───────────────┬─────────────────────────┤
│   AH (高8位)  │     AL (低8位)          │
└───────────────┴─────────────────────────┘

BX (基址寄存器)     - 常用作内存地址指针
CX (计数寄存器)     - 常用作循环计数器
DX (数据寄存器)     - 常用作I/O操作和乘除法
```

**各寄存器的主要用途:**

- **AX (Accumulator)**:
  - 算术运算的主要寄存器
  - I/O操作时存放数据
  - 乘除法运算的隐含操作数

- **BX (Base)**:
  - 常用作内存地址的基址指针
  - 在寻址中作为基址寄存器

- **CX (Counter)**:
  - 循环指令的计数器
  - 字符串操作的重复次数
  - 移位操作的次数

- **DX (Data)**:
  - 乘除法运算时与AX配合使用
  - I/O端口地址
  - 32位乘法结果的高16位

#### 变址寄存器

- **SI (Source Index)**: 源变址寄存器，常用于字符串操作的源地址
- **DI (Destination Index)**: 目的变址寄存器，常用于字符串操作的目标地址

#### 指针寄存器

- **SP (Stack Pointer)**: 栈指针，指向栈顶
- **BP (Base Pointer)**: 基址指针，常用于访问栈中的数据

#### 段寄存器 (16位)

```text
CS (Code Segment)      - 代码段寄存器
DS (Data Segment)      - 数据段寄存器  
ES (Extra Segment)     - 附加段寄存器
SS (Stack Segment)     - 栈段寄存器
```

#### 标志寄存器 (FLAGS)

```text
┌─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┐
│ │ │ │ │O│D│I│T│S│Z│ │A│ │P│ │C│
└─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┘
 15               0

C - 进位标志 (Carry Flag)
P - 奇偶标志 (Parity Flag)  
A - 辅助进位标志 (Auxiliary Carry Flag)
Z - 零标志 (Zero Flag)
S - 符号标志 (Sign Flag)
T - 陷阱标志 (Trap Flag)
I - 中断标志 (Interrupt Flag)
D - 方向标志 (Direction Flag)
O - 溢出标志 (Overflow Flag)
```

#### 指令指针寄存器

- **IP (Instruction Pointer)**: 指令指针，指向下一条要执行的指令

## 🎯 实模式

### 1. 什么是实模式

实模式是8086处理器的原生工作模式，具有以下特点：

- **直接访问物理内存**: 程序可以直接访问所有物理内存
- **20位地址空间**: 可寻址1MB内存 (2^20 = 1,048,576字节)
- **分段内存模型**: 使用段:偏移地址模式
- **无内存保护**: 程序可以访问任意内存位置

### 2. 段:偏移地址模式

```text
物理地址 = 段地址 × 16 + 偏移地址

例如: CS:IP = 1000h:0100h
物理地址 = 1000h × 16 + 0100h = 10000h + 0100h = 10100h
```

### 3. 内存段的组织

```text
┌─────────────────────────────────────────┐ ← FFFFF (1MB-1)
│             扩展内存区域                │
├─────────────────────────────────────────┤ ← F0000
│            ROM BIOS区域                 │
├─────────────────────────────────────────┤ ← E0000
│              保留区域                   │
├─────────────────────────────────────────┤ ← A0000
│           显示缓冲区                    │
├─────────────────────────────────────────┤ ← 9FFFF
│                                         │
│           常规内存区域                  │
│         (DOS和用户程序)                 │
│                                         │
├─────────────────────────────────────────┤ ← 00400
│         中断向量表区域                  │
└─────────────────────────────────────────┘ ← 00000
```

## 📝 8086汇编语言基础

### 1. 汇编语言的特点

- **低级语言**: 接近机器语言，直接操作硬件
- **一一对应**: 基本上一条汇编指令对应一条机器指令
- **平台相关**: 不同处理器有不同的指令集
- **高效率**: 直接控制硬件，执行效率高

### 2. 汇编指令格式

```text
标号: 操作码 操作数1, 操作数2  ; 注释

例如:
start: mov ax, 1234h        ; 将1234h加载到AX寄存器
       add ax, bx           ; 将BX的值加到AX上
       jmp end             ; 跳转到end标号
end:   hlt                 ; 停机指令
```

### 3. 常用汇编指令

#### 数据传送指令

```assembly
; MOV - 数据传送
mov ax, 1234h           ; 立即数 → 寄存器
mov bx, ax              ; 寄存器 → 寄存器  
mov [100h], ax          ; 寄存器 → 内存
mov cx, [200h]          ; 内存 → 寄存器

; PUSH/POP - 栈操作
push ax                 ; 将AX压入栈
pop bx                  ; 从栈弹出到BX

; XCHG - 交换
xchg ax, bx             ; 交换AX和BX的值
```

#### 算术运算指令

```assembly
; 加法运算
add ax, bx              ; AX = AX + BX
add ax, 100h            ; AX = AX + 100h
adc ax, bx              ; 带进位加法

; 减法运算  
sub ax, bx              ; AX = AX - BX
sub ax, 50h             ; AX = AX - 50h
sbb ax, bx              ; 带借位减法

; 乘法运算
mul bx                  ; AX = AL × BL (8位) 或 DX:AX = AX × BX (16位)
imul bx                 ; 有符号乘法

; 除法运算
div bx                  ; AX = DX:AX ÷ BX, DX = 余数
idiv bx                 ; 有符号除法

; 递增递减
inc ax                  ; AX = AX + 1
dec bx                  ; BX = BX - 1
```

#### 逻辑运算指令

```assembly
; 位运算
and ax, bx              ; 按位与
or ax, bx               ; 按位或
xor ax, bx              ; 按位异或
not ax                  ; 按位取反

; 移位运算
shl ax, 1               ; 逻辑左移1位
shr ax, 1               ; 逻辑右移1位
sal ax, 1               ; 算术左移1位
sar ax, 1               ; 算术右移1位
rol ax, 1               ; 循环左移1位
ror ax, 1               ; 循环右移1位
```

#### 比较和测试指令

```assembly
; 比较指令
cmp ax, bx              ; 比较AX和BX (相当于AX-BX，但不改变AX)
cmp ax, 100h            ; 比较AX和立即数

; 测试指令  
test ax, bx             ; 测试 (相当于AX&BX，但不改变AX)
test ax, 0FFh           ; 测试低8位
```

#### 跳转和控制指令

```assembly
; 无条件跳转
jmp start               ; 跳转到start标号
jmp ax                  ; 跳转到AX指定的地址

; 条件跳转 (基于标志位)
je label                ; 相等时跳转 (ZF=1)
jne label               ; 不相等时跳转 (ZF=0)
jz label                ; 为零时跳转 (ZF=1)
jnz label               ; 非零时跳转 (ZF=0)
jc label                ; 有进位时跳转 (CF=1)
jnc label               ; 无进位时跳转 (CF=0)

; 有符号数比较跳转
jg label                ; 大于时跳转
jge label               ; 大于等于时跳转
jl label                ; 小于时跳转
jle label               ; 小于等于时跳转

; 无符号数比较跳转
ja label                ; 高于时跳转
jae label               ; 高于等于时跳转
jb label                ; 低于时跳转
jbe label               ; 低于等于时跳转

; 循环指令
loop label              ; CX减1，如果CX≠0则跳转
loope label             ; CX减1，如果CX≠0且ZF=1则跳转
loopne label            ; CX减1，如果CX≠0且ZF=0则跳转
```

#### 字符串操作指令

```assembly
; 字符串传送
movsb                   ; 传送字节 [DI] ← [SI], SI++, DI++
movsw                   ; 传送字 [DI] ← [SI], SI+=2, DI+=2

; 字符串比较
cmpsb                   ; 比较字节 [SI] - [DI]
cmpsw                   ; 比较字 [SI] - [DI]

; 字符串搜索
scasb                   ; 搜索字节 AL - [DI]
scasw                   ; 搜索字 AX - [DI]

; 重复前缀
rep movsb               ; 重复CX次字节传送
repe cmpsb              ; 相等时重复比较
repne scasb             ; 不相等时重复搜索
```

#### 系统控制指令

```assembly
; 中断指令
int 21h                 ; 调用21h号中断
iret                    ; 中断返回

; 处理器控制
hlt                     ; 停机
nop                     ; 空操作
cli                     ; 关中断
sti                     ; 开中断
```

### 4. 寻址方式

#### 立即寻址

```assembly
mov ax, 1234h           ; 立即数1234h → AX
```

#### 寄存器寻址

```assembly
mov ax, bx              ; BX → AX
```

#### 直接寻址

```assembly
mov ax, [1000h]         ; 内存地址1000h的内容 → AX
```

#### 间接寻址

```assembly
mov ax, [bx]            ; BX指向的内存内容 → AX
mov ax, [si]            ; SI指向的内存内容 → AX
mov ax, [di]            ; DI指向的内存内容 → AX
```

#### 基址寻址

```assembly
mov ax, [bx+100h]       ; (BX+100h)指向的内存内容 → AX
```

#### 变址寻址

```assembly
mov ax, [si+200h]       ; (SI+200h)指向的内存内容 → AX
mov ax, [di+300h]       ; (DI+300h)指向的内存内容 → AX
```

#### 基址变址寻址

```assembly
mov ax, [bx+si]         ; (BX+SI)指向的内存内容 → AX
mov ax, [bx+di+100h]    ; (BX+DI+100h)指向的内存内容 → AX
```

### 5. 汇编程序结构

```assembly
; 简单的汇编程序结构
.model small            ; 内存模型
.stack 100h             ; 栈空间大小

.data                   ; 数据段
    msg db 'Hello, World!$'
    num dw 1234h

.code                   ; 代码段
start:
    mov ax, @data       ; 初始化数据段
    mov ds, ax
    
    ; 主程序代码
    mov ax, num         ; 加载数据
    add ax, 1           ; 加1
    mov num, ax         ; 存回
    
    ; 程序结束
    mov ah, 4ch         ; DOS功能号：程序结束
    int 21h             ; 调用DOS中断
end start
```

## 🚀 学习要点总结

### 核心概念

1. **理解计算机基本组成**: CPU、内存、外存的作用和关系
2. **掌握8086寄存器**: 每个寄存器的用途和使用场景  
3. **理解实模式**: 分段内存模型和地址计算
4. **熟练汇编指令**: 数据传送、算术逻辑、控制转移指令

### 实践技能

1. **能够阅读简单汇编程序**
2. **理解内存地址计算方式**
3. **掌握基本的汇编指令使用**
4. **了解程序的执行流程**

### 为后续学习做准备

- 理解硬件工作原理为操作系统开发奠定基础
- 汇编语言是编写引导程序和内核的必要工具
- 寄存器和内存管理是系统编程的核心

---

💡 **学习建议**:

边学边练，通过编写简单的汇编程序来加深理解，为后续的操作系统内核开发打下坚实的基础。
